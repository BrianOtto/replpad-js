<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Asynchronous DOM Modification</title>

    <!-- Built with `emcc c-pump.c`: _c_on_event(), _c_get_halt_ptr() --> 
    <script src="c-pump.o.js"></script>

    <!-- Interaction with C pump: queueEventToC(), onRequestFromC()... -->
    <script src="js-pump.js"></script>

    <script>
      var typing;
      var prompt;
      var result;

      function onRequestFromC(id, data) {
        switch (id) {
        case 'C_REQUEST_OUTPUT': {
          result.innerHTML += "<tt>" + data + "</tt><br>";

          // Though a DOM modification was made, the user won't see a change
          // until control is returned to the browser.  Hence we *queue* the
          // notification to C, so no C code runs until after the browser has
          // a chance to run.
          // 
          queueEventToC('JS_EVENT_OUTPUT_DONE', null);
          break; }

        case 'C_REQUEST_INPUT': {
          typing.disabled = false;
          typing.style = null;
          prompt.innerHTML = "Enter a String";

          // It could be an indefinite amount of time before the string input
          // is provided via the onTypingEnter() event.
          //
          break; }

        case 'C_REQUEST_SLEEP': {
          //
          // !!! Needs way to have requests parameterized with integers, or
          // perhaps always strings will be used?
          //
          alert("C_REQUEST_SLEEP not implemented yet");
          break; }

        default: {
          alert(id);
          alert("onRequestFromC(" + id + ") : Unknown Request ID");
          break; }
        }
      }

      function onQueueEventToC(id, data) {
        prompt.innerHTML = "(...running C code...)";
      }

      function onFinishEventInC(id) {
        switch (id) {
        case 'JS_EVENT_DOM_CONTENT_LOADED': // startup handled
          result.innerHTML = ""; 
          break;
        }
        prompt.innerHTML = "(...running browser events...)";
      }

      function onHalt() {
        queueHaltOfC();
      }

      function onTypingEnter() {
        //
        // As a sample visual change we might like to take care of before
        // calling back into C, just disable the typed input.  Turn it gray
        // to make it look disabled, then actually disable it.
        //
        typing.style = "color: grey; background-color: #F0F0F0;"; // looks
        typing.disabled = true; // behavior

        queueEventToC('JS_EVENT_GOT_INPUT', typing.value);
      }

      // EVENT 0 => "DOM on Page is set up, start running the C"
      //
      // This will kick off the C code, so that it can run for a while
      // and then--when it decides to--return a request to the pump to
      // be processed.
      //
      document.addEventListener('DOMContentLoaded', function () {
        typing = document.getElementById('typing');
        prompt = document.getElementById('prompt');
        result = document.getElementById('result');
        queueEventToC('JS_EVENT_DOM_CONTENT_LOADED', null);
      });
    </script>
  </head>
  <body>
    <button onclick="onHalt()">Halt</button>
    <div id='prompt'>Initializing</div>
    <div id='result'><tt><b>(...)</b></tt></div>
    <input
      type='TEXT'
      id='typing'
      value='abc'
      style='color: grey; background-color: #F0F0F0;'
      disabled=true
      onkeydown='if (event.key === "Enter") onTypingEnter();'
    >
  </body>
</html>
